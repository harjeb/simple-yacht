rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===== 用户数据规则 (保持宽松但安全) =====
    match /users/{userId} {
      // 允许认证用户读取用户数据（用于查询、匹配、排行榜等）
      allow read: if request.auth != null;
      
      // 用户只能写入自己的数据
      allow write: if request.auth != null && request.auth.uid == userId;
      
      // 或者如果写入也有问题，可以完全放开（仅开发环境）
      // allow write: if request.auth != null;
    }
    
    // ===== 游戏房间规则 =====
    match /gameRooms/{roomId} {
      allow read, write: if request.auth != null;
    }
    
    // ===== 匹配队列规则 =====
    match /matchmakingQueue/{queueId} {
      allow read, write: if request.auth != null;
    }
    
    // ===== 多人游戏规则 =====
    match /multiplayerGames/{gameId} {
      allow read, write: if request.auth != null;
    }
    
    // ===== ELO 评分规则 =====
    match /eloRatings/{userId} {
      allow read, write: if request.auth != null;
    }
    
    // ===== 排行榜规则 =====
    match /leaderboards/{leaderboardType}/scores/{scoreId} {
      allow read: if request.auth != null;
      allow write: if false; // 只能通过 Cloud Functions 操作
    }
    
    // ===== 用户名唯一性集合 =====
    match /usernames/{normalizedUsername} {
      allow read: if request.auth != null;
      allow write: if false; // 只能通过 Cloud Functions 操作
    }
    
    // ===== 好友系统规则 =====
    match /friendships/{friendshipId} {
      allow read, write: if request.auth != null;
    }
    
    // ===== ELO历史规则 =====
    match /eloHistory/{userId}/matches/{matchId} {
      allow read: if request.auth != null;
      allow write: if false; // 只能通过 Cloud Functions 操作
    }
    
    // ===== 游戏统计规则 =====
    match /gameStats/{userId} {
      allow read: if request.auth != null;
      allow write: if false; // 只能通过 Cloud Functions 操作
    }
    
    // ===== 聊天消息规则 =====
    match /gameRooms/{roomId}/messages/{messageId} {
      allow read, write: if request.auth != null;
    }
    
    // ===== 系统配置规则 =====
    match /systemConfig/{configId} {
      allow read: if request.auth != null;
      allow write: if false; // 只能通过管理员操作
    }
    
    // ===== 匹配统计规则 =====
    match /matchmakingStats/{statId} {
      allow read: if request.auth != null;
      allow write: if false; // 只能通过 Cloud Functions 操作
    }
    
    // ===== 排行榜缓存规则 =====
    match /leaderboardCache/{leaderboardType} {
      allow read: if request.auth != null;
      allow write: if false; // 只能通过 Cloud Functions 操作
    }
    
    // ===== 天梯统计规则 =====
    match /ladderStats/{statType} {
      allow read: if request.auth != null;
      allow write: if false; // 只能通过 Cloud Functions 操作
    }
  }
}