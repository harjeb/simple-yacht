rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // 用户集合 (users/{userId})
    match /users/{userId} {
      // 允许已认证用户读取自己的数据
      allow read: if request.auth != null && request.auth.uid == userId;

      // 允许已认证用户查询 transferCode 以检查唯一性（仅在创建用户时）
      allow list: if request.auth != null 
                    && request.query.limit <= 1
                    && request.query.where.size() == 1
                    && request.query.where[0].field == 'transferCode'
                    && request.query.where[0].op == '=='
                    && request.query.where[0].value is string
                    && request.query.where[0].value.matches('^[A-Z0-9]{18}$');

      // 允许新用户创建自己的文档 (注册时)
      // 简化验证以修复 FieldValue.serverTimestamp() 兼容性问题
      allow create: if request.auth != null 
                      && request.auth.uid == userId
                      && 'username' in request.resource.data
                      && request.resource.data.username is string
                      && request.resource.data.username.size() > 0
                      && request.resource.data.username.size() <= 50
                      && 'transferCode' in request.resource.data
                      && request.resource.data.transferCode is string
                      && request.resource.data.transferCode.matches('^[A-Z0-9]{18}$')
                      && 'createdAt' in request.resource.data;

      // 允许已认证用户更新自己的数据
      allow update: if request.auth != null 
                      && request.auth.uid == userId
                      && !('createdAt' in request.resource.data)
                      && !('transferCode' in request.resource.data && request.resource.data.transferCode != resource.data.transferCode);

      // 不允许客户端直接删除用户账户
      allow delete: if false;
    }

    // 排行榜集合 - 修复路径匹配问题
    match /leaderboards/{leaderboardId}/scores/{scoreId} {
      // 允许任何人读取排行榜数据
      allow read: true;

      // 允许已认证用户创建新的分数条目
      allow create: if request.auth != null
                      && request.resource.data.userId == request.auth.uid
                      && request.resource.data.score is number
                      && request.resource.data.score >= 0
                      && 'username' in request.resource.data
                      && request.resource.data.username is string
                      && 'timestamp' in request.resource.data;

      // 不允许更新或删除排行榜条目
      allow update: if false;
      allow delete: if false;
    }
  }
}